# Техническое видение проекта OCR обработки бланков ОТК

## Описание проекта

Проект предназначен для автоматической обработки отсканированных бланков ОТК с помощью OCR технологий. Система выполняет полный цикл обработки: от предварительной подготовки изображений до создания структурированных JSON данных.

## Технологии и фреймворки

**Основные технологии:**
- **Python 3.9+** - основной язык разработки
- **OpenCV** - предобработка изображений (коррекция, улучшение качества)
- **PaddleOCR** - OCR движок для распознавания текста
- **Pydantic** - валидация данных и настроек
- **JSON** - формат вывода данных

**Дополнительные библиотеки:**
- **NumPy** - работа с массивами изображений
- **Pillow** - дополнительная обработка изображений
- **pathlib** - работа с файловой системой
- **logging** - встроенное логирование Python

**Инфраструктура:**
- **Виртуальное окружение Python (venv)** - изоляция зависимостей
- **requirements.txt** - управление зависимостями

## Повышение качества OCR

**Принцип: улучшение точности распознавания через постобработку**

### Словарь исправления ошибок

**Проблема:** PaddleOCR часто допускает типичные ошибки при распознавании русского текста, особенно в специфических терминах бланков ОТК.

**Решение:** Статический словарь частых ошибок для автоматической коррекции:

```python
# src/config/corrections.py
OCR_CORRECTIONS = {
    # Заголовки и метаданные
    "Homep": "Номер",
    "PeB": "Рев",
    "Wmyyep": "Изделие",
    
    # Статусы и решения
    "ne ugim": "не соответствует",
    "друие несоотвтствуя": "другие несоответствия",
    "годн": "годен",
    "бракк": "брак",
    
    # Технические термины
    "ГЕОМЕТРИЯ": "ГЕОМЕТРИЯ",  # Эталонное написание
    "ОТВЕРСТИЯ": "ОТВЕРСТИЯ",
    "РЕЗЬБА": "РЕЗЬБА"
}
```

**Применение:**
- Автоматическая коррекция после OCR
- Логирование исправлений для анализа
- Возможность расширения словаря

### Валидация полей формы

**Типы валидации:**

1. **Числовые поля** - проверка формата чисел, диапазонов
2. **Даты** - валидация формата DD.MM.YYYY
3. **Обязательные поля** - проверка наличия критичных данных
4. **Текстовые паттерны** - проверка соответствия ожидаемым шаблонам

**Правила валидации:**
```python
VALIDATION_RULES = {
    "act_number": {
        "pattern": r"\d+/\d+",
        "required": True,
        "example": "001/2025"
    },
    "date": {
        "pattern": r"\d{1,2}\.\d{1,2}\.\d{4}",
        "required": True,
        "example": "15.10.2025"
    },
    "quantities": {
        "pattern": r"\d+",
        "type": "integer",
        "min": 0
    }
}
```

### Управление порогом уверенности

**Стратегия:**
- **Базовый порог** (0.5) - минимальная уверенность для принятия текста
- **Предупреждение** (0.6) - логирование низкой уверенности
- **Высокая уверенность** (0.8+) - надежные данные

**Обработка низкой уверенности:**
- Логирование проблемных областей
- Пометка в итоговом JSON
- Возможность ручной проверки

### Подход к детекции зон

**Гибридный метод:**

1. **Шаблоны на основе координат** - для известных форматов бланков
2. **Адаптивная детекция** - распознавание по текстовым паттернам
3. **Fallback стратегия** - полное сканирование при неудаче

**Преимущества:**
- Высокая точность для стандартных бланков
- Гибкость при вариациях формата
- Устойчивость к искажениям

## Принципы разработки

**KISS Philosophy:**
- **Максимальная простота решений** - выбираем простейшее работающее решение
- **Никакого оверинжиниринга** - не усложняем архитектуру заранее
- **YAGNI** - не добавляем то, что не нужно сейчас
- **Единственная ответственность** - один модуль = одна функция

**Итеративный подход:**
- **MVP-first** - сначала минимально работающая версия
- **Быстрые циклы** разработка → тест → обратная связь
- **Fail fast, learn fast** - быстрое выявление и исправление ошибок

**Качество кода:**
- **Читаемость важнее оптимизации** - понятный код важнее быстрого
- **Простые, понятные решения** - избегаем "умных" решений
- **Рефакторинг при необходимости, но не заранее**

**Архитектурные принципы:**
- **Модульность** - четкое разделение по функциональности
- **Stateless** - модули не хранят состояние между запусками
- **Единственная ответственность** - каждый модуль решает одну задачу

## Структура проекта

```
Image_ocr/
├── src/                          # Исходный код
│   ├── __init__.py
│   ├── main.py                   # Основной модуль-оркестратор
│   ├── preprocessor.py           # Предобработка изображений (OpenCV)
│   ├── template_detector.py      # Гибридная детекция зон
│   ├── ocr_engine.py            # OCR распознавание (PaddleOCR)
│   ├── error_corrector.py       # Постобработка и коррекция ошибок
│   ├── field_validator.py       # Валидация полей формы
│   ├── form_extractor.py        # Извлечение структурированных данных
│   ├── json_builder.py          # Создание итоговой JSON структуры
│   ├── batch_processor.py       # Пакетная обработка файлов
│   └── config/
│       ├── __init__.py
│       ├── settings.py          # Настройки приложения
│       ├── templates.py         # Шаблоны бланков
│       ├── corrections.py       # Словарь исправлений OCR
│       └── validation_rules.py  # Правила валидации полей
├── images/                      # Входные изображения
├── results/                     # Результаты обработки
├── docs/                        # Документация
├── tests/                       # Тесты (при необходимости)
├── requirements.txt             # Зависимости
├── .env.example                # Пример конфигурации
└── README.md                   # Основная документация
```

**Принципы организации:**
- Плоская структура модулей (без глубокой вложенности)
- Один файл = одна основная функция
- Четкое разделение входных данных, кода и результатов

## Архитектура проекта

**Архитектурный паттерн: Pipeline (Конвейер)**

```
Изображение → Предобработка → Детекция зон → OCR → Коррекция ошибок → Валидация → Структурирование → JSON → Результат
```

**Компоненты пайплайна:**

1. **ImagePreprocessor** - коррекция искажений, улучшение качества
2. **TemplateDetector** - гибридная детекция зон (координаты + паттерны)
   - Использование шаблонов для известных форматов
   - Адаптивное распознавание по текстовым маркерам
   - Fallback на полное сканирование
3. **OCREngine** - распознавание текста в найденных зонах
   - Интеграция PaddleOCR
   - Фильтрация по порогу уверенности
4. **ErrorCorrector** - постобработка результатов OCR
   - Применение словаря исправлений
   - Логирование коррекций
5. **FieldValidator** - валидация извлеченных данных
   - Проверка форматов (даты, числа)
   - Валидация обязательных полей
   - Проверка паттернов
6. **FormExtractor** - извлечение структурированных данных формы
   - Определение назначения колонок по заголовкам
   - Группировка данных по секциям
7. **JSONBuilder** - создание итоговой структуры данных
   - Формирование валидного JSON
   - Добавление метаданных обработки

**Принципы взаимодействия:**
- Каждый компонент получает входные данные и возвращает результат
- Линейная последовательность обработки
- Каждый этап сохраняет промежуточные результаты в `/results/`
- Главный модуль `main.py` оркестрирует весь процесс

**Обработка ошибок:**
- Логирование на каждом этапе
- Graceful degradation - продолжение работы при частичных сбоях
- Сохранение промежуточных результатов для отладки

## Модель данных

**Промежуточные данные (между этапами):**

1. **Предобработанное изображение** → файл с постфиксом `-cor`
2. **Координаты зон** → JSON с постфиксом `-zones`
3. **OCR результаты** → JSON с постфиксом `-texts` 
4. **Исправленные данные** → JSON с постфиксом `-corrected`
5. **Итоговые данные** → JSON с постфиксом `-data`

**Структура итогового JSON:**
```json
{
  "document_info": {
    "filename": "report_2025-10-15_16-45-17.jpg",
    "processing_date": "2025-11-08T10:30:00",
    "template_version": "v1.0",
    "template_used": "otk_v1"
  },
  "zones_detected": {
    "header": {"x": 0, "y": 0, "width": 1920, "height": 200},
    "defects": {"x": 0, "y": 600, "width": 1920, "height": 400},
    "decisions": {"x": 0, "y": 1500, "width": 1920, "height": 400}
  },
  "form_data": {
    "header": {
      "act_number": {
        "value": "АКТ-001",
        "confidence": 0.95,
        "corrected": false,
        "validated": true
      },
      "date": {
        "value": "15.10.2025",
        "confidence": 0.92,
        "corrected": false,
        "validated": true
      },
      "revision": {
        "value": "01",
        "confidence": 0.88,
        "corrected": false,
        "validated": true
      },
      "inspector": {
        "value": "Иванов И.И.",
        "confidence": 0.85,
        "corrected": false,
        "validated": false
      }
    },
    "defects": [
      {
        "code": "Д001",
        "description": "Царапина на поверхности",
        "quantity": 1,
        "decision": "Устранить",
        "confidence": 0.87
      }
    ],
    "decisions": [
      {
        "parameter": "Размер детали",
        "standard": "100±0.1",
        "actual": "100.05",
        "result": "Годен",
        "confidence": 0.91
      }
    ]
  },
  "validation_results": {
    "total_fields": 12,
    "validated_fields": 10,
    "failed_validations": 2,
    "errors": [
      {
        "field": "inspector",
        "error": "Low confidence",
        "value": "Иванов И.И.",
        "confidence": 0.85
      }
    ]
  },
  "corrections_applied": {
    "count": 3,
    "corrections": [
      {
        "field": "header.act_number_label",
        "original": "Homep",
        "corrected": "Номер"
      }
    ]
  },
  "processing_metrics": {
    "total_time_ms": 2500,
    "preprocessing_time_ms": 300,
    "ocr_time_ms": 1200,
    "correction_time_ms": 150,
    "validation_time_ms": 100,
    "structuring_time_ms": 750,
    "ocr_confidence": 0.89,
    "zones_detected": 3,
    "texts_recognized": 75,
    "errors_corrected": 3
  }
}
```

**Pydantic модели для валидации:**
- `DocumentInfo` - метаданные документа
- `ZoneCoordinates` - координаты обнаруженных зон
- `FieldValue` - значение поля с метаданными (значение, уверенность, статус коррекции/валидации)
- `HeaderData`, `DefectRecord`, `DecisionRecord` - данные секций формы
- `ValidationResult` - результаты валидации
- `CorrectionRecord` - запись об исправлении
- `ProcessingMetrics` - метрики обработки

## Мониторинг

**Принцип: простое логирование + базовые метрики**

**Что отслеживаем:**
- Время обработки каждого этапа пайплайна
- Качество OCR (confidence score)
- Количество успешно обработанных файлов
- Ошибки и исключения

**Инструменты:**
- **Python logging** - структурированные логи
- **Простые метрики** в JSON результатах
- **Файловые логи** с ротацией

**Метрики в результатах:**
```json
"processing_metrics": {
  "total_time_ms": 1500,
  "preprocessing_time_ms": 200,
  "ocr_time_ms": 800,
  "ocr_confidence": 0.92,
  "zones_detected": 3,
  "errors_count": 0
}
```

**Логирование:**
- INFO: начало/конец обработки файла
- WARNING: низкое качество OCR
- ERROR: ошибки обработки
- DEBUG: детальная информация для отладки

## Сценарии работы

**Основные сценарии использования:**

### 1. Обработка одного файла
```bash
python src/main.py --file images/report_2025-10-15_16-45-17.jpg
```
- Загрузка изображения
- Полный пайплайн обработки
- Сохранение результатов в `/results/`
- Вывод метрик в консоль

### 2. Пакетная обработка каталога
```bash
python src/batch_processor.py --input images/ --output results/
```
- Обработка всех изображений в каталоге
- Сводный отчет по всем файлам
- Логирование процесса

### 3. Обработка с настройками
```bash
python src/main.py --file image.jpg --template otk_v2 --quality high
```
- Использование конкретного шаблона бланка
- Настройка качества обработки

**Выходные файлы для каждого изображения:**
- `filename-cor.jpg` - предобработанное изображение
- `filename-zones.json` - координаты обнаруженных зон
- `filename-texts.json` - результаты OCR
- `filename-corrected.json` - исправленные данные OCR
- `filename-data.json` - итоговая структура данных с валидацией

**Типичный workflow:**
1. Поместить изображения в `/images/`
2. Запустить обработку
3. Получить результаты в `/results/`
4. Проанализировать логи при необходимости

## Деплой (локально)

**Принцип: максимально простая установка и запуск**

### Требования к системе
- Python 3.9+
- 2GB RAM (для PaddleOCR)
- 1GB свободного места на диске

### Установка и настройка
```bash
# 1. Клонирование/загрузка проекта
git clone <repository> или распаковка архива

# 2. Создание виртуального окружения
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate     # Windows

# 3. Установка зависимостей
pip install -r requirements.txt

# 4. Настройка конфигурации
cp .env.example .env
# Редактирование .env при необходимости

# 5. Проверка работоспособности
python src/main.py --help
```

### Структура после установки
```
Image_ocr/
├── venv/                # Виртуальное окружение
├── src/                 # Готовый к работе код
├── images/              # Папка для входных файлов
├── results/             # Папка для результатов
└── logs/                # Папка для логов (создается автоматически)
```

## Подход к конфигурированию

**Принцип: простые файлы конфигурации + переменные окружения**

### Структура конфигурации

**1. Основные настройки (.env файл):**
```bash
# Пути
INPUT_DIR=images
OUTPUT_DIR=results
LOG_DIR=logs

# OCR настройки
OCR_LANGUAGE=ru
OCR_CONFIDENCE_THRESHOLD=0.5
OCR_USE_GPU=false

# Обработка изображений
IMAGE_SCALE_FACTOR=2
ENABLE_DESKEW=true
ENABLE_DENOISING=true

# Логирование
LOG_LEVEL=INFO
LOG_MAX_SIZE_MB=10
```

**2. Шаблоны бланков (JSON файлы):**
```python
# src/config/templates.py
TEMPLATES = {
    "otk_v1": "config/templates/otk_v1.json",
    "otk_v2": "config/templates/otk_v2.json"
}
```

**3. Pydantic для валидации:**
```python
# src/config/settings.py
from pydantic import BaseSettings

class Settings(BaseSettings):
    input_dir: str = "images"
    output_dir: str = "results"
    ocr_confidence_threshold: float = 0.5
    log_level: str = "INFO"
    
    class Config:
        env_file = ".env"
```

**Приоритет настроек:**
1. Переменные окружения
2. .env файл  
3. Значения по умолчанию

## Подход к логгированию

**Принцип: отдельный лог-файл для каждого запуска**

### Структура логирования

**Файловая структура:**
```
logs/
├── app_2025-11-08_10-30-15.log    # Запуск в 10:30:15
├── app_2025-11-08_14-22-03.log    # Запуск в 14:22:03
└── app_2025-11-08_16-45-12.log    # Запуск в 16:45:12
```

**Формат имени файла:**
```
app_YYYY-MM-DD_HH-MM-SS.log
```

**Уровни логирования:**
- **INFO** - основные события обработки
- **WARNING** - предупреждения
- **ERROR** - ошибки обработки

**Формат сообщений:**
```
2025-11-08 10:30:15 - INFO - Processing image: report_001.jpg
2025-11-08 10:30:16 - WARNING - Low OCR confidence: 0.65
2025-11-08 10:30:17 - INFO - Processing completed in 1.5s
```

**Настройки:**
- Логи в консоль + файл
- Автоматическое создание имени файла при запуске
- Сохранение логов за последние 30 дней (настраивается)

## Подход к проектной документации

**Принцип: минимум необходимой документации**

### Структура документации
```
docs/
├── vision.md            # Техническое видение (этот документ)
├── README.md            # Быстрый старт и основная информация
└── api.md               # Описание модулей и функций (при необходимости)
```

**Содержание документов:**
- **README.md** - установка, запуск, примеры использования
- **vision.md** - техническое видение и архитектура
- **Комментарии в коде** - docstrings для основных функций

**Принципы:**
- Документация пишется по мере необходимости
- Приоритет - понятный код над подробной документацией
- Обновление документации при значимых изменениях

## План разработки по итерациям

**Итерация 1: Базовая инфраструктура** ✅
- Настройка проекта и зависимостей
- Базовая структура модулей
- Конфигурация и логирование
- Простой main.py для тестирования

**Итерация 2: Предобработка изображений** ✅
- Модуль коррекции искажений и наклона
- Улучшение качества изображения
- Сохранение результатов с постфиксом `-cor`

**Итерация 3: OCR распознавание** ✅
- Интеграция PaddleOCR
- Распознавание текста полного изображения
- Сохранение результатов с постфиксом `-texts`
- Обработка confidence score

**Итерация 4: Улучшение OCR и коррекция ошибок**
- Словарь исправления частых ошибок OCR
- Постобработка результатов распознавания
- Валидация числовых полей и дат
- Тестирование улучшений на существующих результатах

**Итерация 5: Детекция зон и структурирование данных**
- Гибридная детекция зон (шаблоны + адаптивное распознавание)
- Извлечение данных по секциям формы
- Определение назначения колонок
- Создание структурированного JSON

**Итерация 6: Система шаблонов и валидация**
- Конфигурируемые шаблоны бланков
- Правила валидации полей
- Сопоставление с шаблонами
- Итоговая структура данных с метаданными

**Итерация 7: Пакетная обработка и финализация**
- Модуль пакетной обработки каталога
- Оптимизация производительности пайплайна
- Сводные отчеты
- Финальное тестирование и документация

---

*Документ создан: 2025-11-08*  
*Версия: 1.0*

